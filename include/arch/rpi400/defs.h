
/*
 *                         OS-3o3 Operating System
 *
 *                      12 may MMXXIV PUBLIC DOMAIN
 *           The authors disclaim copyright to this source code.
 *
 *
 */

#ifndef __DEFS_H__
#define __DEFS_H__ 1

#define RAM_EXTERNAL_SIZE (1024 * 1024 * 1024)
#define START_ADDRESS 0x80000

#define ARM_IO_BASE 0xFE000000
#define PERIPHERAL_BASE 0xFE000000
#define GPU_CACHED_BASE 0x40000000
#define GPU_UNCACHED_BAS 0xC0000000
#define GPU_MEM_BASE GPU_UNCACHED_BAS

/* FIXME address */
#define MEM_COHERENT_REGION ((0x10000000ULL - 3 * (1024 * 1024)) & ~(2 * (1024 * 1024) - 1))

/* index into MAIR0 register*/
#define ATTRINDX_NORMAL 0
#define ATTRINDX_DEVICE 1
#define ATTRINDX_COHERENT 2

#define ATTRIB_SH_NON_SHAREABLE 0
#define ATTRIB_SH_OUTER_SHAREABLE 2
#define ATTRIB_SH_INNER_SHAREABLE 3

#define ARM_CONTROL_MMU (1 << 0)
#define ARM_CONTROL_STRICT_ALIGNMENT (1 << 1)
#define ARM_CONTROL_L1_CACHE (1 << 2)
#define ARM_CONTROL_BRANCH_PREDICTION (1 << 11)
#define ARM_CONTROL_L1_INSTRUCTION_CACHE (1 << 12)

#define MMU_MODE (ARM_CONTROL_MMU | ARM_CONTROL_L1_CACHE | ARM_CONTROL_L1_INSTRUCTION_CACHE | ARM_CONTROL_BRANCH_PREDICTION)

/* System registers*/
#define LPAE_TTBCR_EAE (1 << 31) /* TTBCR */
#define LPAE_TTBCR_EPD1 (1 << 23)
#define LPAE_TTBCR_A1 (1 << 22)
#define LPAE_TTBCR_SH0__SHIFT 12
#define LPAE_TTBCR_SH0__MASK (3 << 12)
#define LPAE_TTBCR_ORGN0__SHIFT 10
#define LPAE_TTBCR_ORGN0__MASK (3 << 10)
#define LPAE_TTBCR_ORGN0_WR_BACK_ALLOCATE 1
#define LPAE_TTBCR_ORGN0_WR_BACK 3
#define LPAE_TTBCR_IRGN0__SHIFT 8
#define LPAE_TTBCR_IRGN0__MASK (3 << 8)
#define LPAE_TTBCR_IRGN0_WR_BACK_ALLOCATE 1
#define LPAE_TTBCR_IRGN0_WR_BACK 3
#define LPAE_TTBCR_EPD0 (1 << 7)
#define LPAE_TTBCR_T0SZ__MASK (7 << 0)
#define LPAE_TTBCR_T0SZ_4GB 0

#define LPAE_MAIR_NORMAL 0xFF /* MAIRn */
#define LPAE_MAIR_DEVICE 0x04
#define LPAE_MAIR_COHERENT 0x00

#define IRQ_MASK irq_mask
#define IRQ_STATUS irq_status
#define IRQ_COUNTER18 1
#define IRQ_COUNTER18_NOT 2

#define PERIPHERAL_BASE 0xFE000000
#define HZ 100
#define CLOCKHZ 1000000
#define ARM_IO_BASE 0xFE000000

#define UART1_ENABLE 1
#define UART1_CLOCK 250000000
#define UART1_MAX_QUEUE (16 * 1024)
#define UART1_BAUD ((UART1_CLOCK / (115200 * 8)) - 1)

#define GPFSEL0 (PERIPHERAL_BASE + 0x200000)
#define GPFSEL1 (PERIPHERAL_BASE + 0x200004)
#define GPSET0 (PERIPHERAL_BASE + 0x20001C)
#define GPCLR0 (PERIPHERAL_BASE + 0x200028)
#define GPPUPPDN0 (PERIPHERAL_BASE + 0x2000E4)
#define GPIO_FUNCTION_ALT5 2

#define PL011_BASE (PERIPHERAL_BASE + 0x201000)
#define PL011_DR (PL011_BASE + 0x00)
#define PL011_FR (PL011_BASE + 0x18)
#define PL011_IBRD (PL011_BASE + 0x24)
#define PL011_FBRD (PL011_BASE + 0x28)
#define PL011_LCRH (PL011_BASE + 0x2C)
#define PL011_CR (PL011_BASE + 0x30)
#define PL011_IFLS (PL011_BASE + 0x34)
#define PL011_IMSC (PL011_BASE + 0x38)
#define PL011_RIS (PL011_BASE + 0x3C)
#define PL011_MIS (PL011_BASE + 0x40)
#define PL011_ICR (PL011_BASE + 0x44)
#define PL011_TXFF (1 << 5)
#define PL011_RXFE (1 << 4)

#define VIDEOCORE_MBOX (PERIPHERAL_BASE + 0xB880)
#define MBOX_READ VIDEOCORE_MBOX
#define MBOX_POLL (VIDEOCORE_MBOX + 0x10)
#define MBOX_SENDER (VIDEOCORE_MBOX + 0x14)
#define MBOX_STATUS (VIDEOCORE_MBOX + 0x18)
#define MBOX_CONFIG (VIDEOCORE_MBOX + 0x1C)
#define MBOX_WRITE (VIDEOCORE_MBOX + 0x20)
#define MBOX_RESPONSE 0x80000000
#define MBOX_FULL 0x80000000
#define MBOX_EMPTY 0x40000000
#define MBOX_REQUEST 0
#define MBOX_CH_POWER 0
#define MBOX_CH_FB 1
#define MBOX_CH_VUART 2
#define MBOX_CH_VCHIQ 3
#define MBOX_CH_LEDS 4
#define MBOX_CH_BTNS 5
#define MBOX_CH_TOUCH 6
#define MBOX_CH_COUNT 7
#define MBOX_CH_PROP 8
#define MBOX_TAG_SETPOWER 0x28001
#define MBOX_TAG_SETCLKRATE 0x38002
#define MBOX_TAG_SETPHYWH 0x48003
#define MBOX_TAG_SETVIRTWH 0x48004
#define MBOX_TAG_SETVIRTOFF 0x48009
#define MBOX_TAG_SETDEPTH 0x48005
#define MBOX_TAG_SETPXLORDR 0x48006
#define MBOX_TAG_GETFB 0x40001
#define MBOX_TAG_GETPITCH 0x40008
#define MBOX_TAG_LAST 0

#define ARM_GICC_BASE 0xFF842000
#define ARM_GICD_BASE 0xFF841000
#define IRQ_LINES 256

#define GICD_CTLR (ARM_GICD_BASE + 0x000)
#define GICD_ISENABLER0 (ARM_GICD_BASE + 0x100)
#define GICD_ICENABLER0 (ARM_GICD_BASE + 0x180)
#define GICD_ITARGETSR0 (ARM_GICD_BASE + 0x800)

#define GICC_IAR (ARM_GICC_BASE + 0x00C)
#define GICC_IAR_INTERID 0x3FF
#define CEOIR (ARM_GICC_BASE + 0x010)
#define CEOIR_ID_MASK (0x3FF)

/* https://github.com/rsta2/circle/blob/master/lib/bcmpciehostbridge.cpp */
#define ARM_PCIE_HOST_BASE 0xFD500000ULL
#define ARM_PCIE_HOST_END (ARM_PCIE_HOST_BASE + 0x930F)
#define MEM_PCIE_RANGE_START_VIRTUAL 0xFA000000UL
#define ARM_XHCI0_BASE MEM_PCIE_RANGE_START_VIRTUAL
#define ARM_XHCI0_END (ARM_XHCI0_BASE + 0x0FFF)
#define ARM_IRQLOCAL0_CNTPNS (16 + 14)
#define ARM_IRQ_USB (32 + 73)
#define ARM_IRQ_PCIE_HOST_INTA (32 + 143)
#define ARM_IRQ_PCIE_HOST_MSI (32 + 148)

#define PCI_MAX_BUS 2
#define PCI_MAX_SLOT 1
#define PCI_MAX_FUNCTION 1

#define MEM_PCIE_RANGE_START 0x600000000ULL
#define MEM_PCIE_RANGE_SIZE 0x4000000ULL
#define MEM_PCIE_RANGE_PCIE_START 0xF8000000ULL /*mapping on PCIe side*/

#define MEM_PCIE_DMA_RANGE_START 0ULL
#define MEM_PCIE_DMA_RANGE_SIZE 0x100000000ULL
#define MEM_PCIE_DMA_RANGE_PCIE_START 0ULL

#define XHCI_MAX_CONTROLLER 2

#define XHCI_DEFAULT_BASE0 ARM_XHCI0_BASE

#define XHCI_SUPPORTED_VERSION 0x100
#define XHCI_CONFIG_MAX_SLOTS 32
#define XHCI_CONFIG_MAX_PORTS 5
#define XHCI_CONTEXT_SIZE 32

#define XHCI_PCIE_BUS 1
#define XHCI_PCIE_SLOT 0
#define XHCI_PCIE_FUNC 0
#define XHCI_PCI_CLASS_CODE 0xC0330
#endif /*__DEFS_H__*/
